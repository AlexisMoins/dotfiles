# Author: Alexis Moins
# Creation: 3 avril 2021
# vim: ft=zsh syn=zsh

# Set the credentials for the gitlab account of the IUT.
#
config-gitlab-repo() {
    git config --local user.name  'amoins001'
    git config --local user.email 'alexis.moins@etu.u-bordeaux.fr'
}

# Restores the tmux sessions with the information retrieved 
# from the session file found at ${SESSIONSFILE}.
#
restore-tmux-sessions() {
    [[ -n "${TMUX}" ]] || [[ ! -f "${SESSIONSFILE}" ]] && return 1
    # Starts the server if not up already
    tmux start-server
    # Reads the sessions
    read-sessions-file
}

# Reads the sessions file and decides how to proceed with the
# retrieved information.
#
read-sessions-file() {
    IFS=$'\t'
    while read session window dir; do
        [[ -d "${dir}" ]] && deserialize-session "${session}" "${window}" "${dir}"
    done < "${SESSIONSFILE}"
}

# Deserializes the given session information.
#
# param {1} the name of session
# param {2} the name of the window
# param {3} the directory of the window
#
deserialize-session() {
    tmux has-session -t "${1}" 2>/dev/null && \
        tmux new-window -d -t "${1}" -n "${2}" -c "${3}" && return 0
    tmux new-session -d -c "${3}" -s "${1}" -n "${2}"
}

# Save the sessions running on the current tmux server 
# into the file specified in ${SESSIONSFILE}.
#
save-tmux-sessions() {
    IFS=$'\t'
    # Declares the pattern used to store a session's data
    pattern="#S${IFS}#W${IFS}#{pane_current_path}"
    # Stores the retrieved data into the sessions file
    tmux list-windows -a -F "${pattern}" > "${SESSIONSFILE}"
}
